<script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css">

{% assign collection_main = collections[section.settings.collection_main] %}

{% assign collection_limit = section.settings.collection_limit %}

{% assign cell_align = section.settings.cell_align %}

{% assign wrap_around = section.settings.wrap_around %}

{% assign img_width = section.settings.img_width | append: 'x' %}

<div
  class="flickity-section-{{ section.id }} flickity-index-slider collection"
  style="background-color: {{ section.settings.bg }}"
>
  <div class="page-width">
    <div>
      <p class="text-title text-center" style="margin-bottom:{{ section.settings.title_mb }}px">
        {{ section.settings.title }}
      </p>
    </div>

    <div
      class="flickity-section__carousel carousel-{{section.id }} text-center"

      data-flickity='
        {
        "cellAlign": "{{ cell_align }}",
        "pageDots": false,
        "freeScroll": true,
        "contain": true,
        "wrapAround": {{ wrap_around }}
        }
      '
    >
      {% for product in collection_main.products limit: collection_limit %}
        {%- if product.metafields.inventory.ShappifyHidden == 'true' -%}{%- continue -%}{%- endif -%}

        {% assign first_variant = product.selected_or_first_available_variant %}

        {% assign featured_img_src = first_variant.featured_img.src | default: product.featured_image.src %}

        {% assign price = first_variant.price %}

        {% assign compare_at_price = first_variant.compare_at_price %}

        <div
          class="carousel__cell"
          style="width:{{ section.settings.cell_width }};margin-right:{{ section.settings.mr }}px"
        >
          <a href="{{ product.url }}">
            {% comment %} <img
              class="lazyload"
              data-src="{{ card_collection.featured_image | img_url: img_width }}"
              alt="{{ card_collection.featured_image.alt }}"
            > {% endcomment %}
          <div
            class="card__inner {% if settings.card_style == 'standard' %}color-{{ settings.card_color_scheme }} gradient{% endif %}{% if card_product.featured_media or settings.card_style == 'standard' %} ratio{% endif %}"
            style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;"
          >
          <div class="card__media{% if image_shape and image_shape != 'default' %} shape--{{ image_shape }} color-{{ settings.card_color_scheme }} gradient{% endif %}">
            <div class="media media--transparent media--hover-effect">
              {% comment %}theme-check-disable ImgLazyLoading{% endcomment %}
              <img
                srcset="
                  {%- if card_product.featured_media.width >= 165 -%}{{ card_product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 360 -%}{{ card_product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 533 -%}{{ card_product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 720 -%}{{ card_product.featured_media | image_url: width: 720 }} 720w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 940 -%}{{ card_product.featured_media | image_url: width: 940 }} 940w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 1066 -%}{{ card_product.featured_media | image_url: width: 1066 }} 1066w,{%- endif -%}
                  {{ card_product.featured_media | image_url }} {{ card_product.featured_media.width }}w
                "
                src="{{ card_product.featured_media | image_url: width: 533 }}"
                sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
                alt="{{ card_product.featured_media.alt | escape }}"
                class="motion-reduce"
                {% unless lazy_load == false %}
                  loading="lazy"
                {% endunless %}
                width="{{ card_product.featured_media.width }}"
                height="{{ card_product.featured_media.height }}"
              >
              {% comment %}theme-check-enable ImgLazyLoading{% endcomment %}

              {%- if card_product.media[1] != null and show_secondary_image -%}
                <img
                  srcset="
                    {%- if card_product.media[1].width >= 165 -%}{{ card_product.media[1] | image_url: width: 165 }} 165w,{%- endif -%}
                    {%- if card_product.media[1].width >= 360 -%}{{ card_product.media[1] | image_url: width: 360 }} 360w,{%- endif -%}
                    {%- if card_product.media[1].width >= 533 -%}{{ card_product.media[1] | image_url: width: 533 }} 533w,{%- endif -%}
                    {%- if card_product.media[1].width >= 720 -%}{{ card_product.media[1] | image_url: width: 720 }} 720w,{%- endif -%}
                    {%- if card_product.media[1].width >= 940 -%}{{ card_product.media[1] | image_url: width: 940 }} 940w,{%- endif -%}
                    {%- if card_product.media[1].width >= 1066 -%}{{ card_product.media[1] | image_url: width: 1066 }} 1066w,{%- endif -%}
                    {{ card_product.media[1] | image_url }} {{ card_product.media[1].width }}w
                  "
                  src="{{ card_product.media[1] | image_url: width: 533 }}"
                  sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
                  alt=""
                  class="motion-reduce"
                  loading="lazy"
                  width="{{ card_product.media[1].width }}"
                  height="{{ card_product.media[1].height }}"
                >
              {%- endif -%}
            </div>
          </div>
        </div>
          </a>

          <a href="{{ product.url }}">
            <h5>{{ product.title }}</h5>
          </a>

          {% if compare_at_price > price %}
            <span class="product__compare-at-price">{{ compare_at_price | money }}</span>

            <span class="product__product-price">{{ price | money }}</span>

          {% else %}
            <span class="product__product-price">{{ price | money }}</span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Collection Slider",

  "settings": [
    {
      "type": "collection",
      "id": "collection_main",
      "label": "Choose a Collection"
    },
    {
      "type": "range",
      "id": "collection_limit",
      "min": 2,
      "max": 50,
      "step": 1,
      "unit": ".",
      "label": "How many products to show",
      "default": 4
    },
    {
      "type": "color",
      "id": "bg",
      "label": "Background Color"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Featured Collection Slider"
    },
    {
      "type": "range",
      "id": "img_width",
      "min": 200,
      "max": 600,
      "step": 5,
      "unit": "px",
      "label": "Image Width",
      "default": 200
    },
    {
      "type": "select",
      "id": "cell_align",
      "label": "Slide Alignment",
      "options": [
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "left",
          "label": "Left"
        }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "title_mb",
      "min": 30,
      "max": 120,
      "step": 1,
      "unit": "px",
      "label": "Title Margin Bottom",
      "default": 48
    },

    {
      "type": "select",
      "id": "cell_width",
      "label": "Choose number of slides to show on start",
      "options": [
        {
          "value": "25%",
          "label": "Four"
        },
        {
          "value": "20%",
          "label": "Five"
        },
        {
          "value": "16.6666667%",
          "label": "Six"
        },
        {
          "value": "12.5%",
          "label": "Eight"
        }
      ],
      "default": "25%"
    },

    {
      "type": "radio",
      "id": "wrap_around",
      "label": "Enable Wrap Around (endless scrolling)",
      "options": [
        {
          "value": "true",
          "label": "True"
        },
        {
          "value": "false",
          "label": "False"
        }
      ],

      "default": "true"
    },

    {
      "type": "range",
      "id": "mr",
      "min": 0,
      "max": 48,
      "step": 1,
      "unit": "px",
      "label": "Cell Margin Right",
      "default": 16,
      "info": "Save page to see changes."
    }
  ],

  "presets": [
    {
      "name": "Collection Slider",

      "category": "Slider"
    }
  ]
}
{% endschema %}
